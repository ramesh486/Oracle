name: Deploy to Terraform Cloud

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # - name: Create tar.gz of Terraform files
      #   run: |
      #     tar -czf terraform-config.tar.gz *.tf
      #     echo "Created terraform-config.tar.gz"
      #     ls -lh terraform-config.tar.gz
      
      - name: Get Workspace ID
        id: workspace
        run: |
          echo "Fetching workspace ID..."
          WORKSPACE_ID=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            -H "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/organizations/${{ secrets.ORG_NAME }}/workspaces/${{ secrets.WORKSPACE_NAME }}" \
            | jq -r '.data.id')
          
          if [ -z "$WORKSPACE_ID" ] || [ "$WORKSPACE_ID" = "null" ]; then
            echo "Error: Failed to fetch workspace ID"
            exit 1
          fi
          
          echo "workspace_id=$WORKSPACE_ID" >> $GITHUB_OUTPUT
          echo "Workspace ID: $WORKSPACE_ID"
      
      - name: Create Configuration Version
        id: config_version
        run: |
          echo "Creating configuration version..."
          RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            -H "Content-Type: application/vnd.api+json" \
            -X POST \
            -d '{"data":{"type":"configuration-versions"}}' \
            "https://app.terraform.io/api/v2/workspaces/${{ steps.workspace.outputs.workspace_id }}/configuration-versions")
          
          UPLOAD_URL=$(echo $RESPONSE | jq -r '.data.attributes."upload-url"')
          
          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" = "null" ]; then
            echo "Error: Failed to get upload URL"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
          echo "Upload URL received"
      
      - name: Upload Configuration
        run: |
          echo "Uploading Terraform configuration..."
          HTTP_STATUS=$(curl -w "%{http_code}" -o /tmp/upload_response.txt \
            -X PUT \
            -H "Content-Type: application/octet-stream" \
            --data-binary @terraform-config.tar.gz \
            "${{ steps.config_version.outputs.upload_url }}")
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Error: Upload failed with status code $HTTP_STATUS"
            cat /tmp/upload_response.txt
            exit 1
          fi
          
          echo "Upload completed successfully (HTTP $HTTP_STATUS)"
